<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" media="screen" href="buttons.css" />
    <script src="src/index.js" defer></script>
    <script src="src/store.js"></script>
    <script src="env.js"></script>
  </head>
  <style>
    * {
      padding: 0;
      margin: 0;
    }

    html {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 2rem;
      height: 100vh;
      width: 40vw;
    }

    button,
    input[type='submit'],
    input {
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      position: relative;
      overflow: hidden;
      outline-color: #869aff;
      outline-width: 3px;
    }

    *:disabled {
      pointer-events: none;
    }

    button:disabled {
      color: grey;
      background-color: #ececec;
    }

    input {
      border: 1px solid grey;
    }

    ul {
      list-style: none;
    }

    #search-form {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
    }

    #search-results {
      height: 50%;
      overflow: auto;
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
    }

    #search-results li {
      font-size: 1em;
      padding: 1em;
    }

    #search-results li:hover {
      background-color: #2b00ff07;
      transition: all 100ms;
    }

    #search-results li:not(:last-child) {
      border-bottom: 1px dashed #ececec;
    }

    #search-results a:first-child {
      display: block;
      color: black;
      font-size: 1.2em;
      text-decoration: none;
      font-weight: 600;
    }

    #search-results p {
      color: #585757;
    }

    #search-results p > b {
      color: black;
    }
  </style>
  <body>
    <form onsubmit="handleSearchFormSubmit(event)" id="search-form">
      <input required name="search" placeholder="search" />
      <button is="pretty-button" type="submit">Submit</button>
    </form>

    <template id="search-result-template">
      <li>
        <a name="title-link" rel="noopener noreferrer" target="_blank"></a>
        <a name="link" rel="noopener noreferrer" target="_blank"></a>
        <span name="content"></span>
      </li>
    </template>

    <ul id="search-results"></ul>

    <template id="pagination-template">
      <form onsubmit="handlePaginationSubmit(event)">
        <button is="pretty-button" class="light" type="submit" name="prev">
          &lt
        </button>
        <span name="current"></span>
        <button is="pretty-button" class="light" type="submit" name="next">
          &gt
        </button>
      </form>
    </template>

    <div id="pagination"></div>
  </body>
  <script>
    const resultStorage = ((key) => ({
      get: () => JSON.parse(localStorage.getItem(key)),
      set: (value) => {
        localStorage.setItem(key, JSON.stringify(value));
      },
    }))('last-result');

    Store.subscribe(
      ({ results }) => {
        if (!results) {
          return;
        }

        const resultListElement = document.querySelector('#search-results');
        resultListElement.innerHTML = '';
        results.items?.forEach((resultItem) =>
          resultListElement.appendChild(renderResultItem(resultItem))
        );

        const paginationElement = document.querySelector('#pagination');
        paginationElement.innerHTML = '';
        paginationElement.appendChild(renderPagination(results.queries));
      },
      (state) => state.results
    );

    Store.subscribe(
      (state) => resultStorage.set(state.results),
      (state) => state.results
    );

    Store.setState({ query: '', results: resultStorage.get() || null });

    async function handleSearchFormSubmit(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const query = formData.get('search');
      const data = await fetchSearchQuery(query);
      Store.setState({ query, results: data });
    }

    async function handlePaginationSubmit(event) {
      event.preventDefault();
      const lastQuery = resultStorage.get().queries.request[0].searchTerms;
      const offset = event.submitter.value;
      const data = await fetchSearchQuery(lastQuery, offset ?? 0);
      Store.setState({ results: data });
    }

    async function fetchSearchQuery(query, offset = 0) {
      const response = await fetch(
        `https://www.googleapis.com/customsearch/v1?q=${query}&key=${credentials.key}&cx=${credentials.cx}&start=${offset}`
      );
      return response.json();
    }

    function n(name, tagName = '*') {
      return `${tagName}[name=${name}]`;
    }

    function renderResultItem(item) {
      const resultTemplate = document.querySelector('#search-result-template');
      const resultItemElement = resultTemplate.content.cloneNode(true);

      const titleElement = resultItemElement.querySelector(n('title-link'));
      titleElement.textContent = item.title;
      titleElement.href = item.link;

      const linkElement = resultItemElement.querySelector(n('link'));
      linkElement.textContent = item.displayLink;
      linkElement.href = item.link;

      const contentElement = resultItemElement.querySelector(n('content'));
      const testElement = document.createElement('p');
      testElement.innerHTML = item.htmlSnippet;
      contentElement.appendChild(testElement);

      return resultItemElement;
    }

    function renderPagination(queries) {
      const template = document.querySelector('#pagination-template');
      const formElement = template.content.cloneNode(true);

      const prevButton = formElement.querySelector(n('prev'));
      if (!queries.previousPage) {
        prevButton.disabled = true;
      } else {
        prevButton.value = queries.previousPage[0].startIndex;
      }

      const nextButton = formElement.querySelector(n('next'));
      if (!queries.nextPage) {
        nextButton.disabled = true;
      } else {
        nextButton.value = queries.nextPage[0].startIndex;
      }

      return formElement;
    }
  </script>
</html>
