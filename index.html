<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script type="module" src="src/components.js" defer></script>
    <script src="env"></script>
  </head>
  <style>
    * {
      padding: 0;
      margin: 0;
      box-sizing: border-box;
      outline-color: #869aff;
    }

    html {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      width: 400px;
      outline: 1px solid red;
    }

    button,
    input[type='submit'],
    input {
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      position: relative;
      overflow: hidden;

      outline-width: 3px;
    }

    *:disabled {
      pointer-events: none;
    }

    button:disabled {
      color: grey;
      background-color: #ececec;
    }

    input {
      border: 1px solid grey;
    }

    ul {
      list-style: none;
    }

    #search-form {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem;
    }

    #search-form input {
      flex-grow: 1;
    }

    #loading-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 3rem;
      overflow: hidden;
      transition: height 100ms;
    }

    #loading-wrapper[data-is-visible='false'] {
      height: 0;
    }

    #search-results {
      overflow: auto;
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
      padding: 0 1rem;
      height: 0;
      transition: height 100ms;

      --pseudo-radius: 50%;
    }

    #search-results:not(:empty) {
      height: 500px;
    }

    #search-results:empty ~ #pagination {
      visibility: hidden;
    }

    #search-results li {
      font-size: 1em;
      padding: 1em;
    }

    #search-results li:hover,
    #search-results li:focus-within {
      background-color: #7256ff13;
      transition: all 100ms;
    }

    #search-results li:not(:last-child) {
      border-bottom: 1px dashed #ececec;
    }

    #search-results a:first-child {
      display: block;
      color: black;
      font-size: 1.2em;
      text-decoration: none;
      font-weight: 600;
    }

    #search-results p {
      color: #585757;
    }

    #search-results p > b {
      color: black;
    }

    .light {
      --base-color: rgb(223, 223, 255);
      --accent-color: rgba(94, 94, 250, 0.29);
      --color: rgb(0 0 152);
    }

    #pagination {
      position: absolute;
      bottom: 1rem;
      transition: transform 100ms ease-in;
    }

    #pagination[data-is-visible='false']:not(:focus-within) {
      transform: translateY(150%);
    }

    #pagination .light {
      --base-color: rgba(223, 223, 255, 0.593);
      backdrop-filter: blur(3px);
    }
  </style>
  <body>
    <form id="search-form">
      <input required name="search" placeholder="search" />
      <button is="pretty-button" type="submit">Submit</button>
    </form>

    <div id="loading-wrapper" data-is-visible="false">
      <span>searching...</span>
    </div>

    <template id="search-result-template">
      <li>
        <a name="title-link" rel="noopener noreferrer" target="_blank"></a>
        <a name="link" rel="noopener noreferrer" target="_blank"></a>
        <span name="content"></span>
      </li>
    </template>

    <ul id="search-results" is="pretty-scroll"></ul>

    <template id="pagination-template">
      <form>
        <button is="pretty-button" class="light" type="submit" name="more">
          more
        </button>
      </form>
    </template>

    <div id="pagination" data-is-visible="false"></div>
  </body>
  <script type="module">
    import { Store, isScrollEnd } from './src/utils.js';

    const resultStorage = ((key) => ({
      get: () => JSON.parse(localStorage.getItem(key)),
      set: (value) => {
        localStorage.setItem(key, JSON.stringify(value));
      },
    }))('last-result');

    Store.subscribe(
      ({ results }) => {
        const resultListElement = document.querySelector('#search-results');
        resultListElement.innerHTML = '';

        const paginationElement = document.querySelector('#pagination');
        paginationElement.innerHTML = '';

        if (!results) {
          return;
        }

        results.items?.forEach((resultItem) =>
          resultListElement.appendChild(renderResultItem(resultItem))
        );

        paginationElement.appendChild(renderPagination(results.queries));
      },
      (state) => state.results
    );

    Store.subscribe(
      (state) => {
        if (!state.results) {
          return;
        }
        resultStorage.set(state.results);
      },
      (state) => state.results
    );

    Store.setState({ results: resultStorage.get() || null });

    const [
      resultsElement,
      paginationElement,
      searchFormElement,
      loadingElement,
    ] = [
      '#search-results',
      '#pagination',
      '#search-form',
      '#loading-wrapper',
    ].map((selector) => document.querySelector(selector));

    Store.subscribe(
      (state) => {
        paginationElement.dataset.isVisible = !!state.isPaginationVisible;
      },
      (state) => state.isPaginationVisible
    );

    Store.subscribe(
      (state) => {
        loadingElement.dataset.isVisible = !!state.isLoading;
      },
      (state) => state.isLoading
    );

    searchFormElement?.addEventListener('submit', async (event) => {
      event.preventDefault();
      Store.setState({ results: null, isLoading: true });
      const formData = new FormData(event.target);
      const query = formData.get('search');
      const data = await fetchSearchQuery(query);
      Store.setState({ results: data, isLoading: false });
    });

    async function handlePaginationSubmit(event) {
      event.preventDefault();
      const lastQuery = resultStorage.get().queries.request[0].searchTerms;
      const offset = event.submitter.value;
      const data = await fetchSearchQuery(lastQuery, offset ?? 0);
      Store.setState((prevState) => {
        const prevResults = prevState.results;
        const newResults = data;
        newResults.items = prevResults.items.concat(newResults.items);

        return { ...prevState, results: newResults };
      });
    }

    async function fetchSearchQuery(query, offset = 0) {
      // const response = await fetch(
      //   `https://www.googleapis.com/customsearch/v1?q=${query}&key=${KEY}&cx=${CX}&start=${offset}`
      // );
      // return response.json();

      await new Promise((resolve) => setTimeout(resolve, 1000));
      return resultStorage.get();
    }

    function n(name, tagName = '*') {
      return `${tagName}[name=${name}]`;
    }

    function renderResultItem(item) {
      const resultTemplate = document.querySelector('#search-result-template');
      const templateFragment = resultTemplate.content.cloneNode(true);

      const titleElement = templateFragment.querySelector(n('title-link'));
      titleElement.textContent = item.title;
      titleElement.href = item.link;

      const linkElement = templateFragment.querySelector(n('link'));
      linkElement.textContent = item.displayLink;
      linkElement.href = item.link;

      const contentElement = templateFragment.querySelector(n('content'));
      const testElement = document.createElement('p');
      testElement.innerHTML = item.htmlSnippet;
      contentElement.appendChild(testElement);

      return templateFragment;
    }

    function renderPagination(queries) {
      const template = document.querySelector('#pagination-template');
      const templateFragment = template.content.cloneNode(true);

      const moreButton = templateFragment.querySelector(n('more'));
      if (!queries.nextPage) {
        moreButton.disabled = true;
      } else {
        moreButton.value = queries.nextPage[0].startIndex;
      }

      const formElement = templateFragment.querySelector('form');
      formElement.addEventListener('submit', handlePaginationSubmit);

      return templateFragment;
    }

    resultsElement?.addEventListener('mousemove', (event) => {
      const { clientY } = event;
      const { top } = resultsElement.getBoundingClientRect();
      const elementHeight = resultsElement.offsetHeight;
      const relativeTop = clientY - top;
      const topPercentage = (relativeTop * 100) / elementHeight;

      Store.setState({
        isPaginationVisible: topPercentage > 80 || isScrollEnd(resultsElement),
      });
    });

    resultsElement?.addEventListener('scroll', ({ target: element }) => {
      Store.setState({
        isPaginationVisible: isScrollEnd(element),
      });
    });
  </script>
</html>
